name: åŸºäº Tag éƒ¨ç½²æ–‡æ¡£åˆ° GitHub Pages

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v1.2.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾
      - 'docs-v*.*.*'  # åŒ¹é… docs-v1.0.0 ç­‰æ–‡æ¡£ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'æŒ‡å®šè¦éƒ¨ç½²çš„æ ‡ç­¾'
        required: false
        default: ''

# è®¾ç½®æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿›è¡Œçš„è¿è¡Œä¹‹é—´æ’é˜Ÿçš„è¿è¡Œã€‚
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è®©è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆã€‚
concurrency:
  group: "pages-tag-deploy"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿ Docusaurus å¯ä»¥è®¡ç®—æœ€åä¿®æ”¹æ—¶é—´
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: è·å–æ ‡ç­¾ä¿¡æ¯
        id: tag_info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "éƒ¨ç½²æ ‡ç­¾: $TAG_NAME"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: ./package-lock.json

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºç½‘ç«™
        run: npm run build
        env:
          DOCUSAURUS_TAG: ${{ steps.tag_info.outputs.tag_name }}

      - name: è®¾ç½® Pages
        uses: actions/configure-pages@v4

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pages"
          echo "ğŸ·ï¸ éƒ¨ç½²æ ‡ç­¾: ${{ needs.build.outputs.tag_name || github.ref_name }}"
          echo "ğŸŒ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
